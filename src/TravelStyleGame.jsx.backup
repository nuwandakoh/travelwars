import React, { useState, useEffect } from 'react';
import { Clock } from 'lucide-react';

// Visual Components (defined outside main component to avoid render issues)
const SceneBackground = ({ scene, weather }) => {
  const getSceneEmoji = (scene) => {
    const scenes = {
      city_street: "üèôÔ∏è",
      landmark: "üóΩ",
      jazz_bar: "üé∑üé∂",
      tourist_area: "üõçÔ∏è",
      hotel_restaurant: "üè®üçΩÔ∏è",
      night_market: "üåôüõí",
      sick_room: "ü§¢üõèÔ∏è",
      hostel: "üõèÔ∏èüë•",
      mountain_view: "üèîÔ∏è",
      hitchhike_road: "üõ§Ô∏èü§ö",
      cafe: "‚òïüìö",
      local_home: "üè†üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
      overpriced_shop: "üí∞üõçÔ∏è",
      festival: "üé™üéÜ",
      beach_bonfire: "üèñÔ∏èüî•",
      lost_road: "üõ§Ô∏è‚ùì",
      secret_market: "üåô‚ú®üõí",
      empty_lot: "üåëüóëÔ∏è",
      hotel_room: "üè®üõèÔ∏è",
      festival_night: "üé™üåô",
      festival_crowd: "üë•üò∞",
      museum: "üèõÔ∏èüñºÔ∏è",
      backpacker_meetup: "üéíüë•",
      solo_walk: "üö∂‚Äç‚ôÇÔ∏èüåô",
      hot_spring: "‚ô®Ô∏èüèûÔ∏è",
      temple_sunrise: "‚õ©Ô∏èüåÖ",
      injured_rest: "ü§ïüõèÔ∏è",
      tired_walk: "üò¥üö∂‚Äç‚ôÇÔ∏è",
      sunset_view: "üåÖüèîÔ∏è",
      broken_car: "üöóüí•",
      cooking_class: "üë®‚Äçüç≥üç≥",
      scam_class: "üò§üí∏",
      old_town: "üèõÔ∏èüï∞Ô∏è",
      family_dinner: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶üçΩÔ∏è",
      awkward_meal: "üò¨üçΩÔ∏è",
      standard_tourist: "üì∑üó∫Ô∏è",
      underground_show: "üé≠üåô",
      weird_show: "üòµüé≠"
    };
    return scenes[scene] || "üèôÔ∏è";
  };

  const getWeatherEffect = (weather) => {
    switch (weather) {
      case "sunny": return "‚òÄÔ∏è";
      case "cloudy": return "‚òÅÔ∏è";
      case "rainy": return "üåßÔ∏è";
      default: return "‚òÄÔ∏è";
    }
  };

  return (
    <div className="absolute inset-0 flex items-center justify-center text-8xl opacity-20">
      {getSceneEmoji(scene)} {getWeatherEffect(weather)}
    </div>
  );
};

const CharacterSprite = ({ emotion, isGirlfriend = false }) => {
  const getEmotionEmoji = (emotion) => {
    const emotions = {
      neutral: isGirlfriend ? "üë©" : "üë®",
      happy: isGirlfriend ? "üòäüë©" : "üòäüë®",
      excited: isGirlfriend ? "ü§©üë©" : "ü§©üë®",
      worried: isGirlfriend ? "üòüüë©" : "üòüüë®",
      tired: isGirlfriend ? "üò¥üë©" : "üò¥üë®"
    };
    return emotions[emotion] || (isGirlfriend ? "üë©" : "üë®");
  };

  return (
    <div className="text-6xl animate-pulse">
      {getEmotionEmoji(emotion)}
    </div>
  );
};

const ScoreAnimation = ({ animation }) => {
  const getAnimationEmoji = (type) => {
    switch (type) {
      case 'coin': return 'ü™ô';
      case 'heart': return 'üíñ';
      case 'broken_heart': return 'üíî';
      default: return '‚ú®';
    }
  };

  return (
    <div 
      className="absolute text-2xl font-bold animate-bounce z-10"
      style={{ 
        left: `${animation.x}px`, 
        top: `${animation.y}px`,
        animation: 'float-up 2s ease-out forwards'
      }}
    >
      {getAnimationEmoji(animation.type)} +{animation.value}
    </div>
  );
};

const TravelStyleGame = () => {
  const [gameState, setGameState] = useState('intro');
  const [playerScore, setPlayerScore] = useState(0);
  const [gfScore, setGfScore] = useState(0);
  const [currentDay, setCurrentDay] = useState(1);
  const [storyPath, setStoryPath] = useState([]);
  const [gameLog, setGameLog] = useState([]);
  const [relationshipTemp, setRelationshipTemp] = useState(50); // 0-100 scale
  const [choiceHistory, setChoiceHistory] = useState([]); // Track safe vs risky choices
  const [gfDialogue, setGfDialogue] = useState(""); // Current girlfriend dialogue
  const [currentScene, setCurrentScene] = useState("city"); // Current background scene
  const [weather, setWeather] = useState("sunny"); // Current weather condition
  const [gfEmotion, setGfEmotion] = useState("neutral"); // Girlfriend's current emotion
  const [playerEmotion, setPlayerEmotion] = useState("neutral"); // Player's current emotion
  const [scoreAnimations, setScoreAnimations] = useState([]); // Active score animations
  const [animationCounter, setAnimationCounter] = useState(0); // Counter for animation IDs
  const [playerAvatar, setPlayerAvatar] = useState({
    x: 400, // Center of screen
    y: 300,
    vx: 0, // velocity
    vy: 0,
    speed: 3,
    animation: 'idle'
  });
  const [keysPressed, setKeysPressed] = useState({});

  const totalDays = 7;

  // Visual system functions
  const getSceneForNode = (nodeKey) => {
    const sceneMap = {
      start: "city_street",
      landmark_safe: "landmark",
      musician_good: "jazz_bar",
      musician_bad: "tourist_area",
      hotel_dinner: "hotel_restaurant",
      bbq_good: "night_market",
      bbq_bad: "sick_room",
      decline_friends: "hostel",
      mountain_good: "mountain_view",
      mountain_bad: "hitchhike_road",
      tourist_escape: "cafe",
      guide_good: "local_home",
      guide_bad: "overpriced_shop",
      shopping: "festival",
      scooter_good: "beach_bonfire",
      scooter_bad: "lost_road",
      market_normal: "night_market",
      market_secret: "secret_market",
      market_fail: "empty_lot",
      rest: "hotel_room",
      festival_good: "festival_night",
      festival_bad: "festival_crowd",
      museum_solo: "museum",
      backpack_good: "backpacker_meetup",
      backpack_bad: "solo_walk",
      spring: "hot_spring",
      temple_good: "temple_sunrise",
      temple_bad: "injured_rest",
      tired: "tired_walk",
      view_good: "sunset_view",
      view_bad: "broken_car",
      cook_good: "cooking_class",
      cook_bad: "scam_class",
      oldtown: "old_town",
      dinner_good: "family_dinner",
      dinner_bad: "awkward_meal",
      standard: "standard_tourist",
      show_good: "underground_show",
      show_bad: "weird_show"
    };
    return sceneMap[nodeKey] || "city_street";
  };

  const getWeatherForDay = (day) => {
    const weatherPatterns = ["sunny", "sunny", "cloudy", "rainy", "sunny", "sunny", "sunny"];
    return weatherPatterns[day - 1] || "sunny";
  };

  const getEmotionForOutcome = (isGood, isRisky, relationshipTemp) => {
    if (isGood) {
      if (isRisky) return "excited";
      return "happy";
    } else {
      if (relationshipTemp < 30) return "worried";
      return "tired";
    }
  };

  // Animation creation helper
  const createScoreAnimation = (type, value, position) => ({
    id: animationCounter,
    type,
    value,
    x: position === 'left' ? 120 : position === 'right' ? 280 : 200,
    y: 80 + (animationCounter % 3) * 30
  });

  // Girlfriend dialogue system
  const generateGfDialogue = (isSafe, isGoodOutcome, choiceHistory, relationshipTemp) => {
    const recentChoices = choiceHistory.slice(-3); // Last 3 choices
    const riskyCount = recentChoices.filter(choice => !choice.isSafe).length;
    const safeCount = recentChoices.filter(choice => choice.isSafe).length;
    
    // Base dialogue on choice patterns and relationship temperature
    if (isSafe) {
      if (relationshipTemp < 30) {
        return "Finally making some sense...";
      } else if (relationshipTemp > 70) {
        return "I appreciate you considering my feelings üíï";
      } else if (safeCount >= 2) {
        return "You're being so responsible lately!";
      } else {
        return "Smart choice, I like this side of you!";
      }
    } else { // Risky choice
      if (!isGoodOutcome) {
        if (relationshipTemp < 40) {
          return "I told you this would happen... üò©";
        } else {
          return "Oh no... are you okay? I'm worried about you!";
        }
      } else {
        if (riskyCount >= 2) {
          return "You're crazy... but I kinda like it! üòç";
        } else if (relationshipTemp > 60) {
          return "Wow! That was amazing! You're full of surprises!";
        } else {
          return "That worked out! Maybe your way isn't so bad...";
        }
      }
    }
  };

  // Story tree structure
  const storyTree = {
    start: {
      situation: "You arrive at the city. Where should you go first?",
      gfAction: "Checks into hotel as planned",
      gfPoints: 3,
      safe: {
        text: "Head to the famous landmark",
        points: { min: 2, max: 3 },
        outcome: "Nice photos at the landmark",
        next: "landmark_safe"
      },
      risky: {
        text: "Follow that street musician",
        points: { min: -2, max: 7 },
        goodOutcome: "Musician leads you to hidden jazz bar!",
        badOutcome: "You wander into tourist trap...",
        next: { good: "musician_good", bad: "musician_bad" }
      }
    },
    landmark_safe: {
      situation: "Getting late. Time for dinner.",
      gfAction: "Dines at Michelin restaurant",
      gfPoints: 4,
      safe: {
        text: "Eat at hotel restaurant",
        points: { min: 2, max: 3 },
        outcome: "Decent meal",
        next: "hotel_dinner"
      },
      risky: {
        text: "Try that alley BBQ place",
        points: { min: -3, max: 8 },
        goodOutcome: "Best meal ever! Owner gives free drinks!",
        badOutcome: "Food poisoning... bathroom night",
        next: { good: "bbq_good", bad: "bbq_bad" }
      }
    },
    musician_good: {
      situation: "Jazz bar friends invite you tomorrow!",
      gfAction: "Visits National Museum",
      gfPoints: 4,
      safe: {
        text: "Decline, explore alone",
        points: { min: 2, max: 3 },
        outcome: "Visit local shops",
        next: "decline_friends"
      },
      risky: {
        text: "Join mountain day trip",
        points: { min: -2, max: 9 },
        goodOutcome: "Epic adventure! Secret hot spring!",
        badOutcome: "Miss last bus, have to hitchhike...",
        next: { good: "mountain_good", bad: "mountain_bad" }
      }
    },
    musician_bad: {
      situation: "In tourist area. Local offers to guide you.",
      gfAction: "Visits National Museum",
      gfPoints: 4,
      safe: {
        text: "Check map instead",
        points: { min: 1, max: 2 },
        outcome: "Find decent cafe",
        next: "tourist_escape"
      },
      risky: {
        text: "Trust them",
        points: { min: -3, max: 6 },
        goodOutcome: "They're genuine! See real local life!",
        badOutcome: "Led to cousin's overpriced shop...",
        next: { good: "guide_good", bad: "guide_bad" }
      }
    },
    hotel_dinner: {
      situation: "Perfect weather morning!",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Visit shopping district",
        points: { min: 2, max: 3 },
        outcome: "Buy nice souvenirs",
        next: "shopping"
      },
      risky: {
        text: "Rent scooter, explore coast",
        points: { min: -2, max: 8 },
        goodOutcome: "Find hidden beach, no tourists!",
        badOutcome: "Lost, out of gas...",
        next: { good: "scooter_good", bad: "scooter_bad" }
      }
    },
    bbq_good: {
      situation: "Owner recommends secret night market.",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Regular night market",
        points: { min: 2, max: 3 },
        outcome: "Enjoy street food",
        next: "market_normal"
      },
      risky: {
        text: "Find secret market",
        points: { min: -1, max: 7 },
        goodOutcome: "Amazing food and street festival!",
        badOutcome: "Empty lot with two carts...",
        next: { good: "market_secret", bad: "market_fail" }
      }
    },
    bbq_bad: {
      situation: "Recovered. Locals say festival tonight.",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Stay in and rest",
        points: { min: 1, max: 2 },
        outcome: "Room service and movies",
        next: "rest"
      },
      risky: {
        text: "Rally, go to festival",
        points: { min: -2, max: 8 },
        goodOutcome: "Feel great! Festival incredible!",
        badOutcome: "Feel worse, leave early...",
        next: { good: "festival_good", bad: "festival_bad" }
      }
    },
    decline_friends: {
      situation: "Meet solo backpacker at hostel.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Chat, continue plans",
        points: { min: 2, max: 3 },
        outcome: "Visit museum alone",
        next: "museum_solo"
      },
      risky: {
        text: "Team up for adventure",
        points: { min: -1, max: 7 },
        goodOutcome: "They know best spots! Great day!",
        badOutcome: "Boring, slow you down...",
        next: { good: "backpack_good", bad: "backpack_bad" }
      }
    },
    mountain_good: {
      situation: "Locals mention temple sunrise hike.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Enjoy hot spring",
        points: { min: 2, max: 3 },
        outcome: "Relaxing spring day",
        next: "spring"
      },
      risky: {
        text: "Early sunrise hike",
        points: { min: -2, max: 9 },
        goodOutcome: "Best sunrise! Monks invite you for tea!",
        badOutcome: "Too foggy, twisted ankle...",
        next: { good: "temple_good", bad: "temple_bad" }
      }
    },
    mountain_bad: {
      situation: "Finally back. Ride offer to viewpoint.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Taxi back to city",
        points: { min: 1, max: 2 },
        outcome: "Head back tired",
        next: "tired"
      },
      risky: {
        text: "Accept ride",
        points: { min: -3, max: 6 },
        goodOutcome: "Amazing sunset! Cool people!",
        badOutcome: "Car breaks down halfway...",
        next: { good: "view_good", bad: "view_bad" }
      }
    },
    tourist_escape: {
      situation: "Overhear about cooking class at cafe.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Continue cafe hopping",
        points: { min: 2, max: 3 },
        outcome: "Nice coffee, meet travelers",
        next: "cafe"
      },
      risky: {
        text: "Sign up for class",
        points: { min: -2, max: 7 },
        goodOutcome: "Learn authentic dishes! Get recipes!",
        badOutcome: "Tourist scam, teaches nothing...",
        next: { good: "cook_good", bad: "cook_bad" }
      }
    },
    guide_good: {
      situation: "Guide offers family dinner invite.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Decline, explore more",
        points: { min: 2, max: 3 },
        outcome: "Explore old town",
        next: "oldtown"
      },
      risky: {
        text: "Accept dinner",
        points: { min: -1, max: 8 },
        goodOutcome: "Amazing meal! Treated like family!",
        badOutcome: "Awkward, understand no one...",
        next: { good: "dinner_good", bad: "dinner_bad" }
      }
    },
    guide_bad: {
      situation: "Escape shop. Performer invites to show.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Back to tourist areas",
        points: { min: 1, max: 2 },
        outcome: "Visit standard attractions",
        next: "standard"
      },
      risky: {
        text: "Go to underground show",
        points: { min: -3, max: 8 },
        goodOutcome: "Mind-blowing! Meet amazing artists!",
        badOutcome: "Weird, uncomfortable, leave early...",
        next: { good: "show_good", bad: "show_bad" }
      }
    },
    shopping: {
      situation: "Local festival happening!",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Stick to sightseeing",
        points: { min: 2, max: 3 },
        outcome: "Standard activities",
        next: "end"
      },
      risky: {
        text: "Dive into festival",
        points: { min: -2, max: 9 },
        goodOutcome: "Epic cultural experience!",
        badOutcome: "Too crowded...",
        next: { good: "end", bad: "end" }
      }
    },
    scooter_good: {
      situation: "Locals having bonfire party at beach.",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Enjoy beach alone",
        points: { min: 2, max: 3 },
        outcome: "Peaceful beach day",
        next: "end"
      },
      risky: {
        text: "Join bonfire party",
        points: { min: -1, max: 8 },
        goodOutcome: "Amazing night! Lifelong friends!",
        badOutcome: "Too wild, leave early...",
        next: { good: "end", bad: "end" }
      }
    },
    scooter_bad: {
      situation: "Back in city. Last adventure?",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Play safe and relax",
        points: { min: 1, max: 2 },
        outcome: "Chill last days",
        next: "end"
      },
      risky: {
        text: "Sketchy food tour",
        points: { min: -3, max: 7 },
        goodOutcome: "Best food discoveries!",
        badOutcome: "Food poisoning again...",
        next: { good: "end", bad: "end" }
      }
    },
    market_normal: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Good ending",
        next: "end"
      },
      risky: {
        text: "Last adventure",
        points: { min: -2, max: 7 },
        goodOutcome: "Great finale!",
        badOutcome: "Meh ending",
        next: { good: "end", bad: "end" }
      }
    },
    market_secret: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Good ending",
        next: "end"
      },
      risky: {
        text: "Last adventure",
        points: { min: -2, max: 8 },
        goodOutcome: "Epic finale!",
        badOutcome: "Rough ending",
        next: { good: "end", bad: "end" }
      }
    },
    market_fail: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Ok ending",
        next: "end"
      },
      risky: {
        text: "Risk it all",
        points: { min: -3, max: 7 },
        goodOutcome: "Redeemed!",
        badOutcome: "Bad luck",
        next: { good: "end", bad: "end" }
      }
    },
    rest: {
      situation: "Recovered. Explore!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Light sightseeing",
        points: { min: 2, max: 3 },
        outcome: "Safe finish",
        next: "end"
      },
      risky: {
        text: "Make up lost time",
        points: { min: -2, max: 8 },
        goodOutcome: "Strong finish!",
        badOutcome: "Tired ending",
        next: { good: "end", bad: "end" }
      }
    },
    festival_good: {
      situation: "On high! Keep going?",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "End on high note",
        points: { min: 2, max: 3 },
        outcome: "Happy ending",
        next: "end"
      },
      risky: {
        text: "Push your luck",
        points: { min: -2, max: 9 },
        goodOutcome: "Legendary!",
        badOutcome: "Peaked too early",
        next: { good: "end", bad: "end" }
      }
    },
    festival_bad: {
      situation: "Rough moment. Redemption?",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Take it easy",
        points: { min: 1, max: 2 },
        outcome: "Quiet ending",
        next: "end"
      },
      risky: {
        text: "One more shot",
        points: { min: -3, max: 7 },
        goodOutcome: "Comeback!",
        badOutcome: "Rough trip",
        next: { good: "end", bad: "end" }
      }
    },
    museum_solo: {
      situation: "Last stretch!",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Finish peacefully",
        points: { min: 2, max: 3 },
        outcome: "Calm ending",
        next: "end"
      },
      risky: {
        text: "Last thrill",
        points: { min: -2, max: 7 },
        goodOutcome: "Worth it!",
        badOutcome: "Should've relaxed",
        next: { good: "end", bad: "end" }
      }
    },
    backpack_good: {
      situation: "Friend has one more idea...",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Part ways",
        points: { min: 2, max: 3 },
        outcome: "Good goodbye",
        next: "end"
      },
      risky: {
        text: "Last adventure together",
        points: { min: -1, max: 8 },
        goodOutcome: "Best decision!",
        badOutcome: "Overstayed",
        next: { good: "end", bad: "end" }
      }
    },
    backpack_bad: {
      situation: "Free again. Make it count?",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Solo exploration",
        points: { min: 1, max: 2 },
        outcome: "Independent ending",
        next: "end"
      },
      risky: {
        text: "Wing it completely",
        points: { min: -3, max: 7 },
        goodOutcome: "Freedom wins!",
        badOutcome: "Lost cause",
        next: { good: "end", bad: "end" }
      }
    },
    spring: {
      situation: "Refreshed!",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Gentle finish",
        points: { min: 2, max: 3 },
        outcome: "Zen ending",
        next: "end"
      },
      risky: {
        text: "Go big",
        points: { min: -2, max: 8 },
        goodOutcome: "Glory!",
        badOutcome: "Crashed",
        next: { good: "end", bad: "end" }
      }
    },
    temple_good: {
      situation: "Blessed by monks. Continue magic?",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Preserve magic",
        points: { min: 2, max: 3 },
        outcome: "Spiritual ending",
        next: "end"
      },
      risky: {
        text: "Push limits",
        points: { min: -1, max: 9 },
        goodOutcome: "Transcendent!",
        badOutcome: "Fell from grace",
        next: { good: "end", bad: "end" }
      }
    },
    temple_bad: {
      situation: "Injured but not defeated?",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Recover and relax",
        points: { min: 1, max: 2 },
        outcome: "Healing ending",
        next: "end"
      },
      risky: {
        text: "Ignore pain",
        points: { min: -3, max: 6 },
        goodOutcome: "Tough it out!",
        badOutcome: "Regrets",
        next: { good: "end", bad: "end" }
      }
    },
    tired: {
      situation: "Rest or explore?",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Rest up",
        points: { min: 1, max: 2 },
        outcome: "Tired ending",
        next: "end"
      },
      risky: {
        text: "Power through",
        points: { min: -2, max: 7 },
        goodOutcome: "Second wind!",
        badOutcome: "Exhausted",
        next: { good: "end", bad: "end" }
      }
    },
    view_good: {
      situation: "New friends!",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Say goodbye",
        points: { min: 2, max: 3 },
        outcome: "Sweet ending",
        next: "end"
      },
      risky: {
        text: "Keep party going",
        points: { min: -1, max: 8 },
        goodOutcome: "Never forget!",
        badOutcome: "Too much",
        next: { good: "end", bad: "end" }
      }
    },
    view_bad: {
      situation: "Tough luck. Change it?",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Accept defeat",
        points: { min: 1, max: 2 },
        outcome: "Learning ending",
        next: "end"
      },
      risky: {
        text: "Desperate move",
        points: { min: -3, max: 7 },
        goodOutcome: "Miracle!",
        badOutcome: "Total disaster",
        next: { good: "end", bad: "end" }
      }
    },
    cafe: {
      situation: "Final day!",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Wrap up nicely",
        points: { min: 2, max: 3 },
        outcome: "Pleasant ending",
        next: "end"
      },
      risky: {
        text: "Last chaos",
        points: { min: -2, max: 7 },
        goodOutcome: "Saved best!",
        badOutcome: "Ruined it",
        next: { good: "end", bad: "end" }
      }
    },
    cook_good: {
      situation: "Skilled up! Use it?",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Simple finish",
        points: { min: 2, max: 3 },
        outcome: "Satisfied",
        next: "end"
      },
      risky: {
        text: "Cook for strangers",
        points: { min: -1, max: 8 },
        goodOutcome: "Everyone loves it!",
        badOutcome: "Kitchen disaster",
        next: { good: "end", bad: "end" }
      }
    },
    cook_bad: {
      situation: "Scammed but learning!",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Cut losses",
        points: { min: 1, max: 2 },
        outcome: "Lesson learned",
        next: "end"
      },
      risky: {
        text: "Try again",
        points: { min: -3, max: 6 },
        goodOutcome: "Perseverance!",
        badOutcome: "Double scam",
        next: { good: "end", bad: "end" }
      }
    },
    oldtown: {
      situation: "Last day!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "Safe departure",
        points: { min: 2, max: 3 },
        outcome: "Smooth ending",
        next: "end"
      },
      risky: {
        text: "Final escapade",
        points: { min: -2, max: 7 },
        goodOutcome: "No regrets!",
        badOutcome: "Flight risk",
        next: { good: "end", bad: "end" }
      }
    },
    dinner_good: {
      situation: "They want you longer!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "Politely leave",
        points: { min: 2, max: 3 },
        outcome: "Grateful",
        next: "end"
      },
      risky: {
        text: "Stay one more night",
        points: { min: -2, max: 9 },
        goodOutcome: "Unforgettable!",
        badOutcome: "Overstayed",
        next: { good: "end", bad: "end" }
      }
    },
    dinner_bad: {
      situation: "Awkward but free!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "End it here",
        points: { min: 1, max: 2 },
        outcome: "Escaped",
        next: "end"
      },
      risky: {
        text: "Find real locals",
        points: { min: -3, max: 6 },
        goodOutcome: "Found them!",
        badOutcome: "More awkward",
        next: { good: "end", bad: "end" }
      }
    },
    standard: {
      situation: "Trip ending...",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Normal finish",
        points: { min: 2, max: 3 },
        outcome: "Standard",
        next: "end"
      },
      risky: {
        text: "Last ditch",
        points: { min: -2, max: 7 },
        goodOutcome: "Hidden gem!",
        badOutcome: "Wasted time",
        next: { good: "end", bad: "end" }
      }
    },
    show_good: {
      situation: "Artist life!",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Keep memorable",
        points: { min: 2, max: 3 },
        outcome: "Artistic",
        next: "end"
      },
      risky: {
        text: "Join next show",
        points: { min: -1, max: 8 },
        goodOutcome: "Star moment!",
        badOutcome: "Stage fright",
        next: { good: "end", bad: "end" }
      }
    },
    show_bad: {
      situation: "Escape complete!",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Play safe",
        points: { min: 1, max: 2 },
        outcome: "Relief",
        next: "end"
      },
      risky: {
        text: "Better show",
        points: { min: -3, max: 7 },
        goodOutcome: "Redeemed!",
        badOutcome: "Worse show",
        next: { good: "end", bad: "end" }
      }
    }
  };

  const getCurrentNode = () => {
    if (storyPath.length === 0) return storyTree.start;
    const lastPath = storyPath[storyPath.length - 1];
    return storyTree[lastPath] || storyTree.start;
  };

  const makeChoice = (isSafe, random) => {
    const currentNode = getCurrentNode();
    if (!currentNode) return;

    const choice = isSafe ? currentNode.safe : currentNode.risky;
    let points = 0;
    let outcome = '';
    let nextPath = '';

    if (isSafe) {
      points = random < 0.9 ? choice.points.max : choice.points.min;
      outcome = choice.outcome;
      nextPath = choice.next;
    } else {
      const isGood = random < 0.5;
      if (isGood) {
        points = choice.points.max;
        outcome = choice.goodOutcome;
        nextPath = choice.next.good;
      } else {
        points = choice.points.min;
        outcome = choice.badOutcome;
        nextPath = choice.next.bad;
      }
    }

    setPlayerScore(prev => prev + points);
    const gfPoints = currentNode.gfPoints;
    setGfScore(prev => prev + gfPoints);

    // Update choice history
    setChoiceHistory(prev => [...prev, { isSafe, points, outcome }]);

    // Update relationship temperature
    let relationshipChange = 0;
    if (isSafe) {
      relationshipChange = points > 0 ? 2 : -1; // Safe choices stabilize relationship
    } else {
      if (points > 0) {
        relationshipChange = 5; // Good risky outcomes excite her
      } else {
        relationshipChange = -8; // Bad risky outcomes worry her
      }
    }
    setRelationshipTemp(prev => Math.max(0, Math.min(100, prev + relationshipChange)));

    setGameLog(prev => [...prev, {
      day: currentDay,
      player: `${choice.text} ‚Üí ${outcome} (${points > 0 ? '+' : ''}${points})`,
      gf: `${currentNode.gfAction} (+${gfPoints})`
    }]);

    setStoryPath(prev => [...prev, nextPath]);

    // Update visual states
    setCurrentScene(getSceneForNode(nextPath));
    setWeather(getWeatherForDay(currentDay));
    
    // Update character emotions based on outcome
    const isGoodOutcome = outcome.includes("amazing") || outcome.includes("best") || outcome.includes("incredible") || outcome.includes("epic") || outcome.includes("legendary");
    const playerEmotion = getEmotionForOutcome(isGoodOutcome, !isSafe, relationshipTemp);
    const gfEmotion = isGoodOutcome ? (relationshipTemp > 60 ? "excited" : "happy") : (relationshipTemp < 40 ? "worried" : "neutral");
    
    setPlayerEmotion(playerEmotion);
    setGfEmotion(gfEmotion);

    // Generate girlfriend dialogue
    const dialogue = generateGfDialogue(isSafe, isGoodOutcome, choiceHistory, relationshipTemp);
    setGfDialogue(dialogue);

    // Trigger score animations
    const newAnimations = [];
    let currentCounter = animationCounter;
    
    if (points !== 0) {
      newAnimations.push(createScoreAnimation(
        points > 0 ? 'coin' : 'broken_heart', 
        Math.abs(points), 
        'left'
      ));
      currentCounter++;
    }
    if (gfPoints > 0) {
      newAnimations.push(createScoreAnimation(
        'heart', 
        gfPoints, 
        'right'
      ));
      currentCounter++;
    }
    
    setAnimationCounter(currentCounter);
    setScoreAnimations(prev => [...prev, ...newAnimations]);

    // Clear animations after 2 seconds
    setTimeout(() => {
      setScoreAnimations(prev => prev.filter(anim => !newAnimations.find(na => na.id === anim.id)));
    }, 2000);

    if (nextPath === "end" || currentDay >= totalDays) {
      setGameState('ended');
    } else {
      setCurrentDay(prev => prev + 1);
    }
  };

  const startGame = () => {
    setGameState('playing');
    setPlayerScore(0);
    setGfScore(0);
    setCurrentDay(1);
    setStoryPath([]);
    setGameLog([]);
    setRelationshipTemp(50);
    setChoiceHistory([]);
    setGfDialogue("");
    setCurrentScene("city_street");
    setWeather("sunny");
    setGfEmotion("neutral");
    setPlayerEmotion("neutral");
    setScoreAnimations([]);
    setAnimationCounter(0);
  };

  const restartGame = () => {
    setGameState('intro');
  };

  // Keyboard input handling
  useEffect(() => {
    const handleKeyDown = (e) => {
      setKeysPressed(prev => ({ ...prev, [e.key.toLowerCase()]: true }));
    };

    const handleKeyUp = (e) => {
      setKeysPressed(prev => ({ ...prev, [e.key.toLowerCase()]: false }));
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);

    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, []);

  // Animation loop for avatar movement
  useEffect(() => {
    let animationId;

    const animate = () => {
      setPlayerAvatar(prev => {
        let newVx = 0;
        let newVy = 0;
        let newAnimation = 'idle';

        // Handle movement input
        if (keysPressed['w'] || keysPressed['arrowup']) {
          newVy = -prev.speed;
          newAnimation = 'walking';
        }
        if (keysPressed['s'] || keysPressed['arrowdown']) {
          newVy = prev.speed;
          newAnimation = 'walking';
        }
        if (keysPressed['a'] || keysPressed['arrowleft']) {
          newVx = -prev.speed;
          newAnimation = 'walking';
        }
        if (keysPressed['d'] || keysPressed['arrowright']) {
          newVx = prev.speed;
          newAnimation = 'walking';
        }

        // Calculate new position
        let newX = prev.x + newVx;
        let newY = prev.y + newVy;

        // Boundary checking (keep avatar on screen)
        const avatarSize = 40;
        newX = Math.max(avatarSize/2, Math.min(800 - avatarSize/2, newX));
        newY = Math.max(avatarSize/2, Math.min(600 - avatarSize/2, newY));

        return {
          ...prev,
          x: newX,
          y: newY,
          vx: newVx,
          vy: newVy,
          animation: newAnimation
        };
      });

      animationId = requestAnimationFrame(animate);
    };

    animationId = requestAnimationFrame(animate);

    return () => {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
    };
  }, [keysPressed]);

  // Choice area detection
  useEffect(() => {
    if (gameState !== 'playing') return;

    // Define choice areas
    const safeArea = { x: 100, y: 200, width: 200, height: 200 };
    const riskyArea = { x: 500, y: 200, width: 200, height: 200 };

    const avatarSize = 40;
    const inSafeArea = 
      playerAvatar.x + avatarSize/2 > safeArea.x && 
      playerAvatar.x - avatarSize/2 < safeArea.x + safeArea.width &&
      playerAvatar.y + avatarSize/2 > safeArea.y && 
      playerAvatar.y - avatarSize/2 < safeArea.y + safeArea.height;

    const inRiskyArea = 
      playerAvatar.x + avatarSize/2 > riskyArea.x && 
      playerAvatar.x - avatarSize/2 < riskyArea.x + riskyArea.width &&
      playerAvatar.y + avatarSize/2 > riskyArea.y && 
      playerAvatar.y - avatarSize/2 < riskyArea.y + riskyArea.height;

    if (inSafeArea) {
      setPlayerAvatar(prev => ({ ...prev, x: 400, y: 300 }));
      makeChoice(true, Math.random());
    } else if (inRiskyArea) {
      setPlayerAvatar(prev => ({ ...prev, x: 400, y: 300 }));
      makeChoice(false, Math.random());
    }
  }, [playerAvatar.x, playerAvatar.y, gameState]);

  const getCurrentNode = () => {
      situation: "You arrive at the city. Where should you go first?",
      gfAction: "Checks into hotel as planned",
      gfPoints: 3,
      safe: {
        text: "Head to the famous landmark",
        points: { min: 2, max: 3 },
        outcome: "Nice photos at the landmark",
        next: "landmark_safe"
      },
      risky: {
        text: "Follow that street musician",
        points: { min: -2, max: 7 },
        goodOutcome: "Musician leads you to hidden jazz bar!",
        badOutcome: "You wander into tourist trap...",
        next: { good: "musician_good", bad: "musician_bad" }
      }
    },
    landmark_safe: {
      situation: "Getting late. Time for dinner.",
      gfAction: "Dines at Michelin restaurant",
      gfPoints: 4,
      safe: {
        text: "Eat at hotel restaurant",
        points: { min: 2, max: 3 },
        outcome: "Decent meal",
        next: "hotel_dinner"
      },
      risky: {
        text: "Try that alley BBQ place",
        points: { min: -3, max: 8 },
        goodOutcome: "Best meal ever! Owner gives free drinks!",
        badOutcome: "Food poisoning... bathroom night",
        next: { good: "bbq_good", bad: "bbq_bad" }
      }
    },
    musician_good: {
      situation: "Jazz bar friends invite you tomorrow!",
      gfAction: "Visits National Museum",
      gfPoints: 4,
      safe: {
        text: "Decline, explore alone",
        points: { min: 2, max: 3 },
        outcome: "Visit local shops",
        next: "decline_friends"
      },
      risky: {
        text: "Join mountain day trip",
        points: { min: -2, max: 9 },
        goodOutcome: "Epic adventure! Secret hot spring!",
        badOutcome: "Miss last bus, have to hitchhike...",
        next: { good: "mountain_good", bad: "mountain_bad" }
      }
    },
    musician_bad: {
      situation: "In tourist area. Local offers to guide you.",
      gfAction: "Visits National Museum",
      gfPoints: 4,
      safe: {
        text: "Check map instead",
        points: { min: 1, max: 2 },
        outcome: "Find decent cafe",
        next: "tourist_escape"
      },
      risky: {
        text: "Trust them",
        points: { min: -3, max: 6 },
        goodOutcome: "They're genuine! See real local life!",
        badOutcome: "Led to cousin's overpriced shop...",
        next: { good: "guide_good", bad: "guide_bad" }
      }
    },
    hotel_dinner: {
      situation: "Perfect weather morning!",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Visit shopping district",
        points: { min: 2, max: 3 },
        outcome: "Buy nice souvenirs",
        next: "shopping"
      },
      risky: {
        text: "Rent scooter, explore coast",
        points: { min: -2, max: 8 },
        goodOutcome: "Find hidden beach, no tourists!",
        badOutcome: "Lost, out of gas...",
        next: { good: "scooter_good", bad: "scooter_bad" }
      }
    },
    bbq_good: {
      situation: "Owner recommends secret night market.",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Regular night market",
        points: { min: 2, max: 3 },
        outcome: "Enjoy street food",
        next: "market_normal"
      },
      risky: {
        text: "Find secret market",
        points: { min: -1, max: 7 },
        goodOutcome: "Amazing food and street festival!",
        badOutcome: "Empty lot with two carts...",
        next: { good: "market_secret", bad: "market_fail" }
      }
    },
    bbq_bad: {
      situation: "Recovered. Locals say festival tonight.",
      gfAction: "Visits botanical garden",
      gfPoints: 3,
      safe: {
        text: "Stay in and rest",
        points: { min: 1, max: 2 },
        outcome: "Room service and movies",
        next: "rest"
      },
      risky: {
        text: "Rally, go to festival",
        points: { min: -2, max: 8 },
        goodOutcome: "Feel great! Festival incredible!",
        badOutcome: "Feel worse, leave early...",
        next: { good: "festival_good", bad: "festival_bad" }
      }
    },
    decline_friends: {
      situation: "Meet solo backpacker at hostel.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Chat, continue plans",
        points: { min: 2, max: 3 },
        outcome: "Visit museum alone",
        next: "museum_solo"
      },
      risky: {
        text: "Team up for adventure",
        points: { min: -1, max: 7 },
        goodOutcome: "They know best spots! Great day!",
        badOutcome: "Boring, slow you down...",
        next: { good: "backpack_good", bad: "backpack_bad" }
      }
    },
    mountain_good: {
      situation: "Locals mention temple sunrise hike.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Enjoy hot spring",
        points: { min: 2, max: 3 },
        outcome: "Relaxing spring day",
        next: "spring"
      },
      risky: {
        text: "Early sunrise hike",
        points: { min: -2, max: 9 },
        goodOutcome: "Best sunrise! Monks invite you for tea!",
        badOutcome: "Too foggy, twisted ankle...",
        next: { good: "temple_good", bad: "temple_bad" }
      }
    },
    mountain_bad: {
      situation: "Finally back. Ride offer to viewpoint.",
      gfAction: "Designer store shopping",
      gfPoints: 4,
      safe: {
        text: "Taxi back to city",
        points: { min: 1, max: 2 },
        outcome: "Head back tired",
        next: "tired"
      },
      risky: {
        text: "Accept ride",
        points: { min: -3, max: 6 },
        goodOutcome: "Amazing sunset! Cool people!",
        badOutcome: "Car breaks down halfway...",
        next: { good: "view_good", bad: "view_bad" }
      }
    },
    tourist_escape: {
      situation: "Overhear about cooking class at cafe.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Continue cafe hopping",
        points: { min: 2, max: 3 },
        outcome: "Nice coffee, meet travelers",
        next: "cafe"
      },
      risky: {
        text: "Sign up for class",
        points: { min: -2, max: 7 },
        goodOutcome: "Learn authentic dishes! Get recipes!",
        badOutcome: "Tourist scam, teaches nothing...",
        next: { good: "cook_good", bad: "cook_bad" }
      }
    },
    guide_good: {
      situation: "Guide offers family dinner invite.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Decline, explore more",
        points: { min: 2, max: 3 },
        outcome: "Explore old town",
        next: "oldtown"
      },
      risky: {
        text: "Accept dinner",
        points: { min: -1, max: 8 },
        goodOutcome: "Amazing meal! Treated like family!",
        badOutcome: "Awkward, understand no one...",
        next: { good: "dinner_good", bad: "dinner_bad" }
      }
    },
    guide_bad: {
      situation: "Escape shop. Performer invites to show.",
      gfAction: "Visits art gallery",
      gfPoints: 3,
      safe: {
        text: "Back to tourist areas",
        points: { min: 1, max: 2 },
        outcome: "Visit standard attractions",
        next: "standard"
      },
      risky: {
        text: "Go to underground show",
        points: { min: -3, max: 8 },
        goodOutcome: "Mind-blowing! Meet amazing artists!",
        badOutcome: "Weird, uncomfortable, leave early...",
        next: { good: "show_good", bad: "show_bad" }
      }
    },
    shopping: {
      situation: "Local festival happening!",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Stick to sightseeing",
        points: { min: 2, max: 3 },
        outcome: "Standard activities",
        next: "end"
      },
      risky: {
        text: "Dive into festival",
        points: { min: -2, max: 9 },
        goodOutcome: "Epic cultural experience!",
        badOutcome: "Too crowded...",
        next: { good: "end", bad: "end" }
      }
    },
    scooter_good: {
      situation: "Locals having bonfire party at beach.",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Enjoy beach alone",
        points: { min: 2, max: 3 },
        outcome: "Peaceful beach day",
        next: "end"
      },
      risky: {
        text: "Join bonfire party",
        points: { min: -1, max: 8 },
        goodOutcome: "Amazing night! Lifelong friends!",
        badOutcome: "Too wild, leave early...",
        next: { good: "end", bad: "end" }
      }
    },
    scooter_bad: {
      situation: "Back in city. Last adventure?",
      gfAction: "Spa day",
      gfPoints: 4,
      safe: {
        text: "Play safe and relax",
        points: { min: 1, max: 2 },
        outcome: "Chill last days",
        next: "end"
      },
      risky: {
        text: "Sketchy food tour",
        points: { min: -3, max: 7 },
        goodOutcome: "Best food discoveries!",
        badOutcome: "Food poisoning again...",
        next: { good: "end", bad: "end" }
      }
    },
    market_normal: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Good ending",
        next: "end"
      },
      risky: {
        text: "Last adventure",
        points: { min: -2, max: 7 },
        goodOutcome: "Great finale!",
        badOutcome: "Meh ending",
        next: { good: "end", bad: "end" }
      }
    },
    market_secret: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Good ending",
        next: "end"
      },
      risky: {
        text: "Last adventure",
        points: { min: -2, max: 8 },
        goodOutcome: "Epic finale!",
        badOutcome: "Rough ending",
        next: { good: "end", bad: "end" }
      }
    },
    market_fail: {
      situation: "Final days!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Popular sites",
        points: { min: 2, max: 3 },
        outcome: "Ok ending",
        next: "end"
      },
      risky: {
        text: "Risk it all",
        points: { min: -3, max: 7 },
        goodOutcome: "Redeemed!",
        badOutcome: "Bad luck",
        next: { good: "end", bad: "end" }
      }
    },
    rest: {
      situation: "Recovered. Explore!",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Light sightseeing",
        points: { min: 2, max: 3 },
        outcome: "Safe finish",
        next: "end"
      },
      risky: {
        text: "Make up lost time",
        points: { min: -2, max: 8 },
        goodOutcome: "Strong finish!",
        badOutcome: "Tired ending",
        next: { good: "end", bad: "end" }
      }
    },
    festival_good: {
      situation: "On high! Keep going?",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "End on high note",
        points: { min: 2, max: 3 },
        outcome: "Happy ending",
        next: "end"
      },
      risky: {
        text: "Push your luck",
        points: { min: -2, max: 9 },
        goodOutcome: "Legendary!",
        badOutcome: "Peaked too early",
        next: { good: "end", bad: "end" }
      }
    },
    festival_bad: {
      situation: "Rough moment. Redemption?",
      gfAction: "Observatory visit",
      gfPoints: 4,
      safe: {
        text: "Take it easy",
        points: { min: 1, max: 2 },
        outcome: "Quiet ending",
        next: "end"
      },
      risky: {
        text: "One more shot",
        points: { min: -3, max: 7 },
        goodOutcome: "Comeback!",
        badOutcome: "Rough trip",
        next: { good: "end", bad: "end" }
      }
    },
    museum_solo: {
      situation: "Last stretch!",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Finish peacefully",
        points: { min: 2, max: 3 },
        outcome: "Calm ending",
        next: "end"
      },
      risky: {
        text: "Last thrill",
        points: { min: -2, max: 7 },
        goodOutcome: "Worth it!",
        badOutcome: "Should've relaxed",
        next: { good: "end", bad: "end" }
      }
    },
    backpack_good: {
      situation: "Friend has one more idea...",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Part ways",
        points: { min: 2, max: 3 },
        outcome: "Good goodbye",
        next: "end"
      },
      risky: {
        text: "Last adventure together",
        points: { min: -1, max: 8 },
        goodOutcome: "Best decision!",
        badOutcome: "Overstayed",
        next: { good: "end", bad: "end" }
      }
    },
    backpack_bad: {
      situation: "Free again. Make it count?",
      gfAction: "Final shopping",
      gfPoints: 3,
      safe: {
        text: "Solo exploration",
        points: { min: 1, max: 2 },
        outcome: "Independent ending",
        next: "end"
      },
      risky: {
        text: "Wing it completely",
        points: { min: -3, max: 7 },
        goodOutcome: "Freedom wins!",
        badOutcome: "Lost cause",
        next: { good: "end", bad: "end" }
      }
    },
    spring: {
      situation: "Refreshed!",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Gentle finish",
        points: { min: 2, max: 3 },
        outcome: "Zen ending",
        next: "end"
      },
      risky: {
        text: "Go big",
        points: { min: -2, max: 8 },
        goodOutcome: "Glory!",
        badOutcome: "Crashed",
        next: { good: "end", bad: "end" }
      }
    },
    temple_good: {
      situation: "Blessed by monks. Continue magic?",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Preserve magic",
        points: { min: 2, max: 3 },
        outcome: "Spiritual ending",
        next: "end"
      },
      risky: {
        text: "Push limits",
        points: { min: -1, max: 9 },
        goodOutcome: "Transcendent!",
        badOutcome: "Fell from grace",
        next: { good: "end", bad: "end" }
      }
    },
    temple_bad: {
      situation: "Injured but not defeated?",
      gfAction: "Sunset cruise",
      gfPoints: 4,
      safe: {
        text: "Recover and relax",
        points: { min: 1, max: 2 },
        outcome: "Healing ending",
        next: "end"
      },
      risky: {
        text: "Ignore pain",
        points: { min: -3, max: 6 },
        goodOutcome: "Tough it out!",
        badOutcome: "Regrets",
        next: { good: "end", bad: "end" }
      }
    },
    tired: {
      situation: "Rest or explore?",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Rest up",
        points: { min: 1, max: 2 },
        outcome: "Tired ending",
        next: "end"
      },
      risky: {
        text: "Power through",
        points: { min: -2, max: 7 },
        goodOutcome: "Second wind!",
        badOutcome: "Exhausted",
        next: { good: "end", bad: "end" }
      }
    },
    view_good: {
      situation: "New friends!",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Say goodbye",
        points: { min: 2, max: 3 },
        outcome: "Sweet ending",
        next: "end"
      },
      risky: {
        text: "Keep party going",
        points: { min: -1, max: 8 },
        goodOutcome: "Never forget!",
        badOutcome: "Too much",
        next: { good: "end", bad: "end" }
      }
    },
    view_bad: {
      situation: "Tough luck. Change it?",
      gfAction: "Farewell dinner",
      gfPoints: 4,
      safe: {
        text: "Accept defeat",
        points: { min: 1, max: 2 },
        outcome: "Learning ending",
        next: "end"
      },
      risky: {
        text: "Desperate move",
        points: { min: -3, max: 7 },
        goodOutcome: "Miracle!",
        badOutcome: "Total disaster",
        next: { good: "end", bad: "end" }
      }
    },
    cafe: {
      situation: "Final day!",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Wrap up nicely",
        points: { min: 2, max: 3 },
        outcome: "Pleasant ending",
        next: "end"
      },
      risky: {
        text: "Last chaos",
        points: { min: -2, max: 7 },
        goodOutcome: "Saved best!",
        badOutcome: "Ruined it",
        next: { good: "end", bad: "end" }
      }
    },
    cook_good: {
      situation: "Skilled up! Use it?",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Simple finish",
        points: { min: 2, max: 3 },
        outcome: "Satisfied",
        next: "end"
      },
      risky: {
        text: "Cook for strangers",
        points: { min: -1, max: 8 },
        goodOutcome: "Everyone loves it!",
        badOutcome: "Kitchen disaster",
        next: { good: "end", bad: "end" }
      }
    },
    cook_bad: {
      situation: "Scammed but learning!",
      gfAction: "Souvenir shopping",
      gfPoints: 3,
      safe: {
        text: "Cut losses",
        points: { min: 1, max: 2 },
        outcome: "Lesson learned",
        next: "end"
      },
      risky: {
        text: "Try again",
        points: { min: -3, max: 6 },
        goodOutcome: "Perseverance!",
        badOutcome: "Double scam",
        next: { good: "end", bad: "end" }
      }
    },
    oldtown: {
      situation: "Last day!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "Safe departure",
        points: { min: 2, max: 3 },
        outcome: "Smooth ending",
        next: "end"
      },
      risky: {
        text: "Final escapade",
        points: { min: -2, max: 7 },
        goodOutcome: "No regrets!",
        badOutcome: "Flight risk",
        next: { good: "end", bad: "end" }
      }
    },
    dinner_good: {
      situation: "They want you longer!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "Politely leave",
        points: { min: 2, max: 3 },
        outcome: "Grateful",
        next: "end"
      },
      risky: {
        text: "Stay one more night",
        points: { min: -2, max: 9 },
        goodOutcome: "Unforgettable!",
        badOutcome: "Overstayed",
        next: { good: "end", bad: "end" }
      }
    },
    dinner_bad: {
      situation: "Awkward but free!",
      gfAction: "Airport prep",
      gfPoints: 3,
      safe: {
        text: "End it here",
        points: { min: 1, max: 2 },
        outcome: "Escaped",
        next: "end"
      },
      risky: {
        text: "Find real locals",
        points: { min: -3, max: 6 },
        goodOutcome: "Found them!",
        badOutcome: "More awkward",
        next: { good: "end", bad: "end" }
      }
    },
    standard: {
      situation: "Trip ending...",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Normal finish",
        points: { min: 2, max: 3 },
        outcome: "Standard",
        next: "end"
      },
      risky: {
        text: "Last ditch",
        points: { min: -2, max: 7 },
        goodOutcome: "Hidden gem!",
        badOutcome: "Wasted time",
        next: { good: "end", bad: "end" }
      }
    },
    show_good: {
      situation: "Artist life!",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Keep memorable",
        points: { min: 2, max: 3 },
        outcome: "Artistic",
        next: "end"
      },
      risky: {
        text: "Join next show",
        points: { min: -1, max: 8 },
        goodOutcome: "Star moment!",
        badOutcome: "Stage fright",
        next: { good: "end", bad: "end" }
      }
    },
    show_bad: {
      situation: "Escape complete!",
      gfAction: "Goodbye photos",
      gfPoints: 3,
      safe: {
        text: "Play safe",
        points: { min: 1, max: 2 },
        outcome: "Relief",
        next: "end"
      },
      risky: {
        text: "Better show",
        points: { min: -3, max: 7 },
        goodOutcome: "Redeemed!",
        badOutcome: "Worse show",
        next: { good: "end", bad: "end" }
      }
    }
  };

  const getCurrentNode = () => {
    if (storyPath.length === 0) return storyTree.start;
    const lastPath = storyPath[storyPath.length - 1];
    return storyTree[lastPath] || storyTree.start;
  };

  const makeChoice = (isSafe, random) => {
    const currentNode = getCurrentNode();
    if (!currentNode) return;

    const choice = isSafe ? currentNode.safe : currentNode.risky;
    let points = 0;
    let outcome = '';
    let nextPath = '';

    if (isSafe) {
      points = random < 0.9 ? choice.points.max : choice.points.min;
      outcome = choice.outcome;
      nextPath = choice.next;
    } else {
      const isGood = random < 0.5;
      if (isGood) {
        points = choice.points.max;
        outcome = choice.goodOutcome;
        nextPath = choice.next.good;
      } else {
        points = choice.points.min;
        outcome = choice.badOutcome;
        nextPath = choice.next.bad;
      }
    }

    setPlayerScore(prev => prev + points);
    const gfPoints = currentNode.gfPoints;
    setGfScore(prev => prev + gfPoints);

    // Update choice history
    setChoiceHistory(prev => [...prev, { isSafe, points, outcome }]);

    // Update relationship temperature
    let relationshipChange = 0;
    if (isSafe) {
      relationshipChange = points > 0 ? 2 : -1; // Safe choices stabilize relationship
    } else {
      if (points > 0) {
        relationshipChange = 5; // Good risky outcomes excite her
      } else {
        relationshipChange = -8; // Bad risky outcomes worry her
      }
    }
    setRelationshipTemp(prev => Math.max(0, Math.min(100, prev + relationshipChange)));

    setGameLog(prev => [...prev, {
      day: currentDay,
      player: `${choice.text} ‚Üí ${outcome} (${points > 0 ? '+' : ''}${points})`,
      gf: `${currentNode.gfAction} (+${gfPoints})`
    }]);

    setStoryPath(prev => [...prev, nextPath]);

    // Update visual states
    setCurrentScene(getSceneForNode(nextPath));
    setWeather(getWeatherForDay(currentDay));
    
    // Update character emotions based on outcome
    const isGoodOutcome = outcome.includes("amazing") || outcome.includes("best") || outcome.includes("incredible") || outcome.includes("epic") || outcome.includes("legendary");
    const playerEmotion = getEmotionForOutcome(isGoodOutcome, !isSafe, relationshipTemp);
    const gfEmotion = isGoodOutcome ? (relationshipTemp > 60 ? "excited" : "happy") : (relationshipTemp < 40 ? "worried" : "neutral");
    
    setPlayerEmotion(playerEmotion);
    setGfEmotion(gfEmotion);

    // Generate girlfriend dialogue
    const dialogue = generateGfDialogue(isSafe, isGoodOutcome, choiceHistory, relationshipTemp);
    setGfDialogue(dialogue);

    // Trigger score animations
    const newAnimations = [];
    let currentCounter = animationCounter;
    
    if (points !== 0) {
      newAnimations.push(createScoreAnimation(
        points > 0 ? 'coin' : 'broken_heart', 
        Math.abs(points), 
        'left'
      ));
      currentCounter++;
    }
    if (gfPoints > 0) {
      newAnimations.push(createScoreAnimation(
        'heart', 
        gfPoints, 
        'right'
      ));
      currentCounter++;
    }
    
    setAnimationCounter(currentCounter);
    setScoreAnimations(prev => [...prev, ...newAnimations]);

    // Clear animations after 2 seconds
    setTimeout(() => {
      setScoreAnimations(prev => prev.filter(anim => !newAnimations.find(na => na.id === anim.id)));
    }, 2000);

    if (nextPath === "end" || currentDay >= totalDays) {
      setGameState('ended');
    } else {
      setCurrentDay(prev => prev + 1);
    }
  };

  const startGame = () => {
    setGameState('playing');
    setPlayerScore(0);
    setGfScore(0);
    setCurrentDay(1);
    setStoryPath([]);
    setGameLog([]);
    setRelationshipTemp(50);
    setChoiceHistory([]);
    setGfDialogue("");
    setCurrentScene("city_street");
    setWeather("sunny");
    setGfEmotion("neutral");
    setPlayerEmotion("neutral");
    setScoreAnimations([]);
    setAnimationCounter(0);
  };

  if (gameState === 'intro') {